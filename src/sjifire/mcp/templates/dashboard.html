{% extends "base.html" %}

{% block title %}SJIF&amp;R Dashboard{% endblock %}

{% block extra_styles %}
<style>
    /* Animations */
    @keyframes shimmer {
      0%   { background-position: -400px 0; }
      100% { background-position:  400px 0; }
    }

    /* Content wrapper */
    .content-wrap { max-width: 1200px; margin: 0 auto; }

    /* ── Grid layouts ── */
    .grid-4, .grid-3, .grid-overview { display: grid; gap: 16px; }
    .grid-4        { grid-template-columns: repeat(4, 1fr); }
    .grid-3        { grid-template-columns: repeat(3, 1fr); }
    .grid-overview { grid-template-columns: 1fr 1.6fr; gap: 20px; }

    /* ── Overview rows ── */
    .overview-row {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .overview-row:last-child,
    .call-card:last-child { border-bottom: none; }

    /* ── Call cards ── */
    .call-card {
      padding: 14px 18px;
      border-left: 3px solid;
      border-bottom: 1px solid var(--border-subtle);
    }
    .call-card[data-s="high"] {
      border-left-color: var(--color-red);
      background: rgba(220, 38, 38, .1);
    }
    .call-card[data-s="medium"] {
      border-left-color: var(--color-amber-dark);
      background: rgba(245, 158, 11, .08);
    }
    .call-card[data-s="low"] {
      border-left-color: var(--color-gray);
      background: rgba(107, 114, 128, .08);
    }
    .call-card-right { text-align: right; flex-shrink: 0; }

    /* ── Crew ── */
    .crew-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .crew-table td, .crew-table th { white-space: nowrap; }
    .crew-table .shift { text-align: right; }
    .section-header {
      padding: 8px 18px;
      background: rgba(255, 255, 255, .02);
      border-bottom: 1px solid var(--border-subtle);
    }
    .contact-link {
      font-size: 11px;
      color: var(--text-dim);
      text-decoration: none;
    }
    .contact-link:hover {
      color: var(--color-blue);
      text-decoration: underline;
    }
    .contact-link + .contact-link::before {
      content: " | ";
      color: var(--text-faint);
    }

    /* Address link */
    .address-link { color: var(--text-muted); text-decoration: none; }
    .address-link:hover { color: var(--color-blue); text-decoration: underline; }

    /* ── Skeleton loading ── */
    .skeleton {
      background: linear-gradient(90deg,
        var(--border-subtle) 25%,
        var(--border-medium) 50%,
        var(--border-subtle) 75%);
      background-size: 800px 100%;
      animation: shimmer 1.5s ease-in-out infinite;
      border-radius: 4px;
    }
    .skeleton-stat { height: 100px; }
    .skeleton-text { height: 16px; border-radius: 4px; }
    .skeleton-row  { height: 48px; border-bottom: 1px solid var(--border-subtle); }

    /* Footer */
    .dashboard-footer {
      padding: 16px 24px 32px;
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-faint);
    }

    /* ── Dashboard responsive ── */
    @media (max-width: 768px) {
      .grid-4             { grid-template-columns: repeat(2, 1fr); }
      .grid-3,
      .grid-overview,
      .crew-grid           { grid-template-columns: 1fr; }
      .dashboard-main      { padding: 12px; }
      .data-table-wrap     { -webkit-overflow-scrolling: touch; }
      .dashboard-footer    { flex-direction: column; gap: 4px; }
    }
</style>
{% endblock %}

{% block body_attrs %}x-cloak x-data="dashboard()"{% endblock %}

{% block tab_bar %}
<nav class="nav-bar">
  <div class="nav-bar-left">
    <template x-for="t in tabs" :key="t.id">
      <button class="nav-tab" :class="{'active': activeTab === t.id}" @click="activeTab = t.id; location.hash = t.id" x-text="t.label"></button>
    </template>
  </div>
  <div class="nav-bar-right" x-data="headerStatus()" x-cloak>
    <span class="nav-status-date" x-show="date_display" x-text="date_display"></span>
    <div class="status-pill" :class="open_calls ? 'active' : 'ok'" x-show="loaded">
      <span class="pulse-dot"></span>
      <span x-text="open_calls ? open_calls + ' Active Call' + (open_calls > 1 ? 's' : '') : 'No Active Calls'"></span>
    </div>
    <span class="nav-status-updated" x-show="updated_time" x-text="'Updated ' + updated_time"></span>
  </div>
</nav>
{% endblock %}

{% block body %}
<main class="content-wrap dashboard-main" style="padding:24px">

  <!-- LOADING SKELETON -->
  <div x-show="loading">
    <div class="grid-4" style="margin-bottom:24px">
      <div class="skeleton skeleton-stat"></div>
      <div class="skeleton skeleton-stat"></div>
      <div class="skeleton skeleton-stat"></div>
      <div class="skeleton skeleton-stat"></div>
    </div>
    <div class="grid-overview">
      <div class="panel">
        <div class="panel-header"><div class="skeleton skeleton-text" style="width:140px"></div></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-row"></div>
      </div>
      <div class="panel">
        <div class="panel-header"><div class="skeleton skeleton-text" style="width:120px"></div></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-row"></div>
      </div>
    </div>
  </div>

  <!-- ERROR STATE -->
  <div x-show="error && !loading" class="empty-state" style="padding:40px">
    Failed to load dashboard data. Will retry automatically.
  </div>

  <!-- OVERVIEW TAB -->
  <div x-show="!loading && !error && activeTab === 'overview'">
    <div class="grid-4" style="margin-bottom:24px">
      <div class="stat-card accent-green">
        <div class="stat-label">Open Calls</div>
        <div class="stat-value" x-text="D.open_calls"></div>
        <div class="stat-desc" x-text="D.open_calls ? 'Active dispatch' : 'All clear'"></div>
      </div>
      <div class="stat-card accent-blue">
        <div class="stat-label">On Duty</div>
        <div class="stat-value" x-text="D.unique_crew_count"></div>
        <div class="stat-desc" x-text="D.platoon"></div>
      </div>
      <div class="stat-card accent-amber">
        <div class="stat-label">Recent Calls</div>
        <div class="stat-value" x-text="D.recent_calls.length"></div>
        <div class="stat-desc" x-text="D.neris_count + ' submitted to NERIS'"></div>
      </div>
      <div class="stat-card accent-purple">
        <div class="stat-label">Duty Officer</div>
        <div class="stat-value" x-text="D.chief_officer || '\u2014'"></div>
        <div class="stat-desc">Chief Officer</div>
      </div>
    </div>
    <div class="grid-overview">
      <!-- Crew panel -->
      <div class="panel">
        <div class="panel-header">
          <span style="font-size:14px;color:var(--text-primary)" class="font-semibold" x-text="'On Duty \u2014 ' + D.platoon"></span>
          <span class="badge" x-show="D.shift_until" x-text="'until ' + D.shift_until"></span>
        </div>
        <template x-if="D.crew.length">
          <div>
            <template x-for="c in D.crew" :key="c.name + c.shift">
              <div class="overview-row">
                <div>
                  <div style="font-size:13px;font-weight:600;color:var(--text-primary)" x-text="c.name"></div>
                  <div style="font-size:11px;color:var(--text-muted);margin-top:2px" x-text="c.position"></div>
                </div>
                <span class="badge" x-text="c.section"></span>
              </div>
            </template>
          </div>
        </template>
        <template x-if="!D.crew.length">
          <div class="empty-state">No crew data available.</div>
        </template>
      </div>
      <!-- Recent calls panel -->
      <div class="panel">
        <div class="panel-header">
          <span style="font-size:14px;color:var(--text-primary)" class="font-semibold">Recent Calls</span>
          <span style="font-size:11px;color:var(--text-dim)">Last 5 calls</span>
        </div>
        <template x-if="D.recent_calls.length">
          <div>
            <template x-for="c in D.recent_calls.slice(0, 5)" :key="c.id">
              <div class="call-card" :data-s="c.severity">
                <div style="display:flex;justify-content:space-between;align-items:flex-start">
                  <div style="display:flex;gap:10px">
                    <span style="font-size:20px;line-height:1" x-text="c.icon"></span>
                    <div>
                      <div style="font-size:13px;font-weight:600;color:var(--text-secondary)" x-text="c.nature"></div>
                      <a :href="mapsUrl(c.address)" target="_blank" rel="noopener" class="address-link" style="display:block;font-size:12px;margin-top:2px" x-text="c.address"></a>
                      <div x-show="c.short_dsc" style="font-size:11px;color:var(--text-muted);margin-top:2px" x-text="c.short_dsc"></div>
                      <div x-show="c.summary" style="font-size:11px;color:var(--text-dim);margin-top:2px" x-text="c.summary"></div>
                    </div>
                  </div>
                  <div class="call-card-right">
                    <div class="nowrap font-semibold" style="font-size:12px;color:var(--text-muted)" x-text="c.date + ' ' + c.time"></div>
                    <div class="mono font-semibold" style="font-size:12px;color:var(--text-secondary);margin-top:4px" x-text="c.id"></div>
                    <div style="margin-top:4px">
                      <span x-show="c.report_source === 'neris'" class="text-green" style="font-size:11px">&#10003; NERIS</span>
                      <span x-show="c.report_source === 'local'" class="text-blue" style="font-size:11px">&#9998; Draft</span>
                      <span x-show="!c.report_source" class="text-amber" style="font-size:11px">&#9888; No report</span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </template>
        <template x-if="!D.recent_calls.length">
          <div class="empty-state">No recent calls.</div>
        </template>
      </div>
    </div>
  </div>

  <!-- CALLS TAB -->
  <div x-show="!loading && !error && activeTab === 'calls'">
    <div class="panel">
      <div class="panel-header">
        <span style="font-size:14px;color:var(--text-primary)" class="font-semibold">Dispatch Log</span>
        <span style="font-size:11px;color:var(--text-dim)">Last 15 calls</span>
      </div>
      <div class="data-table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th></th>
              <th>ID</th>
              <th>Date/Time</th>
              <th>Nature</th>
              <th>Address</th>
              <th>IC</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="c in D.recent_calls" :key="c.id">
              <tr>
                <td class="dot-cell"><span class="severity-dot" :class="c.severity"></span></td>
                <td class="mono nowrap" style="font-size:12px;color:var(--text-muted)" x-text="c.id"></td>
                <td class="nowrap" style="color:var(--text-secondary)" x-text="c.date + ' ' + c.time"></td>
                <td class="nowrap font-semibold" style="color:var(--text-primary)"><span x-text="c.icon + ' ' + c.nature"></span></td>
                <td><a :href="mapsUrl(c.address)" target="_blank" rel="noopener" class="address-link" x-text="c.address"></a></td>
                <td class="nowrap font-semibold" style="font-size:12px;color:var(--text-secondary)" x-text="c.ic || '\u2014'"></td>
                <td style="font-size:12px;color:var(--text-muted)" x-text="c.short_dsc || '\u2014'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CREW TAB -->
  <div x-show="!loading && !error && activeTab === 'crew'">
    <div class="crew-grid">
    <!-- Current crew -->
    <div class="panel">
      <div class="panel-header">
        <span style="font-size:14px;color:var(--text-primary)" class="font-semibold" x-text="D.platoon + ' \u2014 ' + D.crew_date_range"></span>
        <span class="badge" x-text="D.shift_until ? 'until ' + D.shift_until : 'On duty'"></span>
      </div>
      <template x-if="D.sections.length">
        <div class="data-table-wrap">
          <table class="data-table crew-table">
            <thead><tr>
              <th>Name</th>
              <th>Rank</th>
              <th class="shift">Shift</th>
            </tr></thead>
            <tbody>
              <template x-for="s in D.sections.slice().reverse()" :key="s.key">
                <template x-for="(c, i) in [{_header: true, label: s.label}, ...s.members]" :key="c._header ? 'h-' + s.key : c.name + c.shift">
                  <tr>
                    <template x-if="c._header">
                      <td colspan="3" class="section-header uppercase font-semibold" style="font-size:11px;color:var(--text-dim)" x-text="c.label"></td>
                    </template>
                    <template x-if="!c._header">
                      <td class="nowrap font-semibold" style="font-size:13px;color:var(--text-secondary)">
                        <span x-text="c.name"></span>
                        <span x-show="c.email || c.mobile" style="font-size:11px">
                          <template x-if="c.email">
                            <a class="contact-link" :href="'mailto:' + c.email">email</a>
                          </template>
                          <template x-if="c.mobile">
                            <a class="contact-link" :href="'tel:' + c.mobile">mobile</a>
                          </template>
                        </span>
                      </td>
                    </template>
                    <template x-if="!c._header">
                      <td class="nowrap"><span class="badge" :data-p="c.position" x-text="c.position"></span></td>
                    </template>
                    <template x-if="!c._header">
                      <td class="mono nowrap shift" style="font-size:12px;color:var(--text-dim)" x-text="c.shift"></td>
                    </template>
                  </tr>
                </template>
              </template>
            </tbody>
          </table>
        </div>
      </template>
      <template x-if="!D.sections.length">
        <div class="empty-state">No crew data available.</div>
      </template>
    </div>
    <!-- Upcoming crew -->
    <div class="panel" x-show="D.upcoming_sections.length">
      <div class="panel-header">
        <span style="font-size:14px;color:var(--text-primary)" class="font-semibold" x-text="'Upcoming \u2014 ' + D.upcoming_platoon + ' ' + D.upcoming_date_range"></span>
        <span class="badge" x-text="D.upcoming_shift_starts ? 'starting at ' + D.upcoming_shift_starts : D.upcoming_crew.length + ' crew'"></span>
      </div>
      <template x-if="D.upcoming_sections.length">
        <div class="data-table-wrap">
          <table class="data-table crew-table">
            <thead><tr>
              <th>Name</th>
              <th>Rank</th>
              <th class="shift">Shift</th>
            </tr></thead>
            <tbody>
              <template x-for="s in D.upcoming_sections.slice().reverse()" :key="s.key">
                <template x-for="(c, i) in [{_header: true, label: s.label}, ...s.members]" :key="c._header ? 'h-' + s.key : c.name + c.shift">
                  <tr>
                    <template x-if="c._header">
                      <td colspan="3" class="section-header uppercase font-semibold" style="font-size:11px;color:var(--text-dim)" x-text="c.label"></td>
                    </template>
                    <template x-if="!c._header">
                      <td class="nowrap font-semibold" style="font-size:13px;color:var(--text-secondary)">
                        <span x-text="c.name"></span>
                        <span x-show="c.email || c.mobile" style="font-size:11px">
                          <template x-if="c.email">
                            <a class="contact-link" :href="'mailto:' + c.email">email</a>
                          </template>
                          <template x-if="c.mobile">
                            <a class="contact-link" :href="'tel:' + c.mobile">mobile</a>
                          </template>
                        </span>
                      </td>
                    </template>
                    <template x-if="!c._header">
                      <td class="nowrap"><span class="badge" :data-p="c.position" x-text="c.position"></span></td>
                    </template>
                    <template x-if="!c._header">
                      <td class="mono nowrap shift" style="font-size:12px;color:var(--text-dim)" x-text="c.shift"></td>
                    </template>
                  </tr>
                </template>
              </template>
            </tbody>
          </table>
        </div>
      </template>
    </div>
    </div>
  </div>

  <!-- REPORTING TAB -->
  <div x-show="!loading && !error && activeTab === 'reporting'">
    <div class="grid-3" style="margin-bottom:24px">
      <div class="stat-card accent-blue">
        <div class="stat-label">In Progress</div>
        <div class="stat-value" x-text="D.local_draft_count"></div>
        <div class="stat-desc">Drafts &amp; reviews</div>
      </div>
      <div class="stat-card accent-amber">
        <div class="stat-label">Missing Reports</div>
        <div class="stat-value" x-text="D.missing_reports"></div>
        <div class="stat-desc">No incident report yet</div>
      </div>
      <div class="stat-card accent-green">
        <div class="stat-label">In NERIS</div>
        <div class="stat-value" x-text="D.neris_count"></div>
        <div class="stat-desc">Submitted to NERIS</div>
      </div>
    </div>
    <div class="panel">
      <div class="panel-header">
        <span style="font-size:14px;color:var(--text-primary)" class="font-semibold">Incident Reports</span>
        <span class="badge" x-text="D.recent_calls.length + ' incidents'"></span>
      </div>
      <div class="data-table-wrap">
        <table class="data-table">
          <thead>
            <tr>
              <th></th>
              <th>ID</th>
              <th>Date</th>
              <th>Nature</th>
              <th>IC</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="c in D.recent_calls" :key="'rp-' + c.id">
              <tr>
                <td class="dot-cell"><span class="severity-dot" :class="c.severity"></span></td>
                <td class="mono" style="font-size:12px;color:var(--text-muted)" x-text="c.id"></td>
                <td class="nowrap" style="color:var(--text-secondary)" x-text="c.date + ' ' + c.time"></td>
                <td class="nowrap font-semibold" style="color:var(--text-primary)"><span x-text="c.icon + ' ' + c.nature"></span></td>
                <td class="nowrap font-semibold" style="font-size:12px;color:var(--text-secondary)" x-text="c.ic || '\u2014'"></td>
                <td>
                  <template x-if="c.report_source === 'neris'">
                    <div>
                      <span class="text-green font-semibold" style="font-size:11px">&#10003; <span x-text="c.report_status"></span></span>
                      <template x-if="c.neris_id">
                        <div class="mono" style="font-size:10px;color:var(--text-dim);margin-top:2px" x-text="c.neris_id"></div>
                      </template>
                    </div>
                  </template>
                  <template x-if="c.report_source === 'local'">
                    <span class="text-blue font-semibold" style="font-size:11px">&#9998; <span x-text="c.report_status || 'draft'"></span></span>
                  </template>
                  <template x-if="!c.report_source">
                    <span class="text-amber" style="font-size:11px">&#9888; Missing</span>
                  </template>
                </td>
                <td>
                  <template x-if="c.report_source === 'local' && c.incident_id">
                    <a class="action-btn edit" :href="'/reports/' + c.incident_id">Edit Report</a>
                  </template>
                  <template x-if="c.report_source === 'neris'">
                    <button class="action-btn import" @click="startReport(c)">Import from NERIS</button>
                  </template>
                  <template x-if="!c.report_source">
                    <button class="action-btn start" @click="startReport(c)">Start Report</button>
                  </template>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<footer class="content-wrap dashboard-footer">
  <span>San Juan County Fire District 3 &middot; 1011 Mullis Street, Friday Harbor, WA 98250</span>
  <span>&copy; 2026 SJIF&amp;R</span>
</footer>
{% endblock %}

{% block body_scripts %}
<script>
function dashboard() {
  return {
    D: {
      date_display: '', updated_time: '', is_business_hours: false,
      user_name: '', platoon: '', crew: [], unique_crew_count: 0,
      chief_officer: '', open_calls: 0, recent_calls: [],
      neris_count: 0, local_draft_count: 0, missing_reports: 0,
      sections: [], crew_date_range: '', shift_until: '',
      upcoming_platoon: '', upcoming_crew: [], upcoming_sections: [],
      upcoming_date_range: '', upcoming_shift_starts: ''
    },
    loading: true,
    error: false,
    activeTab: ['overview','calls','crew','reporting'].includes(location.hash.slice(1)) ? location.hash.slice(1) : 'overview',
    tabs: [
      {id: 'overview', label: 'Overview'},
      {id: 'calls', label: 'Recent Calls'},
      {id: 'crew', label: 'On Duty'},
      {id: 'reporting', label: 'Reporting'}
    ],

    async init() {
      await this.refresh();
      setInterval(() => this.refresh(), 3600000);
    },

    async refresh() {
      try {
        const r = await fetch('/dashboard/data');
        if (r.ok) {
          this.D = await r.json();
          this.loading = false;
          this.error = false;
        } else if (r.status === 401) {
          location.reload();
        } else {
          this.error = true;
          this.loading = false;
        }
      } catch (e) {
        console.error('Dashboard refresh failed:', e);
        this.error = true;
        this.loading = false;
      }
    },

    mapsUrl(addr) {
      return 'https://www.google.com/maps/search/?api=1&query=' +
        encodeURIComponent((addr || '') + ', San Juan Island, WA');
    },

    startReport(call) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/reports/new';
      const fields = {
        incident_number: call.id,
        incident_date: this.parseDate(call.date),
        station: 'S31'
      };
      for (const [k, v] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = v;
        form.appendChild(input);
      }
      document.body.appendChild(form);
      form.submit();
    },

    parseDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr + ' ' + new Date().getFullYear());
      if (isNaN(d)) return '';
      return d.toISOString().split('T')[0];
    }
  };
}
</script>
{% endblock %}
