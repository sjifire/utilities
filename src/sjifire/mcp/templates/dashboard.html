<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SJIF&amp;R Dashboard</title>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14/dist/cdn.min.js"></script>
  <style>
[x-cloak]{display:none!important}
*{box-sizing:border-box;margin:0;padding:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
:root{
  --b1:rgba(255,255,255,.04);--b2:rgba(255,255,255,.06);--b3:rgba(255,255,255,.08);--b4:rgba(255,255,255,.1);
  --r:#dc2626;--g:#4ade80;--bl:#60a5fa;--am:#fbbf24;--am2:#f59e0b;--pu:#c084fc;--gr:#6b7280;--err:#f87171;
  --bg1:#162033;--bg2:#1a2744;
  --t1:#fff;--t2:#e2e8f0;--t3:#94a3b8;--t4:#64748b;--t5:#475569;
  --blA:rgba(96,165,250,.12);--amA:rgba(245,158,11,.12);--gA:rgba(34,197,94,.15);--rA:rgba(220,38,38,.15);--puA:rgba(192,132,252,.12)
}
.root{min-height:100vh;background:#0c1829;font-family:'Segoe UI','Helvetica Neue',sans-serif;color:var(--t2)}
.t1{color:var(--t1)}.t2{color:var(--t2)}.t3{color:var(--t3)}.t4{color:var(--t4)}.t5{color:var(--t5)}
.grn-t{color:var(--g)}.amb-t{color:var(--am)}.blu-t{color:var(--bl)}
.f10{font-size:10px}.f11{font-size:11px}.f12{font-size:12px}.f13{font-size:13px}.f14{font-size:14px}.f20{font-size:20px}.f28{font-size:28px}
.b{font-weight:600}.bb{font-weight:700}.mono{font-family:monospace}.nw{white-space:nowrap}.lh1{line-height:1}.lh15{line-height:1.5}
.up{text-transform:uppercase;letter-spacing:.08em}.tar{text-align:right}
.mt2{margin-top:2px}.mt4{margin-top:4px}.mt6{margin-top:6px}.mb8{margin-bottom:8px}.mb16{margin-bottom:16px}.mb24{margin-bottom:24px}.mt20{margin-top:20px}
.fx{display:flex}.fx-s{display:flex;justify-content:space-between;align-items:flex-start}.gap10{gap:10px}
.wrap{max-width:1200px;margin:0 auto}
.g4,.g3,.g-ov{display:grid;gap:16px}
.g4{grid-template-columns:repeat(4,1fr)}.g3{grid-template-columns:repeat(3,1fr)}.g-ov{grid-template-columns:1fr 1.6fr;gap:20px}
.hdr{background:linear-gradient(135deg,#0f2240,#1a3a5c);border-bottom:3px solid var(--r)}
.hdr-inner{padding:12px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.logo{letter-spacing:.02em;line-height:1.2}
.status{display:inline-flex;align-items:center;gap:6px;margin-top:4px;border-radius:20px;padding:3px 12px;border:1px solid}
.status.ok{background:var(--gA);border-color:rgba(34,197,94,.3);color:var(--g)}
.status.ok .pulse{background:var(--g)}
.status.active{background:var(--rA);border-color:rgba(220,38,38,.3);color:var(--err)}
.status.active .pulse{background:var(--err)}
.pulse{width:7px;height:7px;border-radius:50%;display:inline-block;animation:pulse 2s ease-in-out infinite}
.updated-row{margin-top:6px;display:flex;align-items:center;justify-content:flex-end;gap:8px}
.refresh-hint{background:var(--blA);padding:2px 10px;border-radius:12px}
.nav{background:#111d32;border-bottom:1px solid var(--b2);padding:0 24px}
.tab{background:none;border:none;border-bottom:2px solid transparent;color:var(--t4);padding:12px 20px;cursor:pointer;font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:.08em}
.tab.on{border-bottom-color:var(--r);color:var(--t1)}
.pnl{background:var(--bg1);border:1px solid var(--b2);border-radius:8px;overflow:hidden}
.phdr{padding:14px 18px;border-bottom:1px solid var(--b2);display:flex;justify-content:space-between;align-items:center}
.main{padding:24px}
.stat{background:linear-gradient(135deg,var(--bg1),var(--bg2));border:1px solid var(--b2);border-radius:8px;padding:20px 18px;border-left:3px solid}
.stat[data-a="grn"]{border-left-color:var(--g)}
.stat[data-a="blu"]{border-left-color:var(--bl)}
.stat[data-a="amb"]{border-left-color:var(--am2)}
.stat[data-a="pur"]{border-left-color:var(--pu)}
.bdg{font-size:11px;padding:3px 10px;border-radius:4px;font-weight:600;background:var(--blA);color:var(--bl)}
.bdg.amb{background:var(--amA);color:var(--am)}
.bdg.grn{background:var(--gA);color:var(--g)}
.bdg[data-p="Captain"]{background:var(--rA);color:var(--err)}
.bdg[data-p="Lieutenant"]{background:var(--amA);color:var(--am)}
.bdg[data-p="Chief"]{background:var(--puA);color:var(--pu)}
.orow{padding:12px 18px;border-bottom:1px solid var(--b1);display:flex;justify-content:space-between;align-items:center}
.orow:last-child,.call:last-child{border-bottom:none}
.call{padding:14px 18px;border-left:3px solid;border-bottom:1px solid var(--b1)}
.call[data-s="high"]{border-left-color:var(--r);background:rgba(220,38,38,.1)}
.call[data-s="medium"]{border-left-color:var(--am2);background:rgba(245,158,11,.08)}
.call[data-s="low"]{border-left-color:var(--gr);background:rgba(107,114,128,.08)}
.call-r{text-align:right;flex-shrink:0}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.dot[data-s="high"]{background:var(--r)}
.dot[data-s="medium"]{background:var(--am2)}
.dot[data-s="low"]{background:var(--gr)}
.tbl-wrap{overflow-x:auto}
.tbl{width:100%;border-collapse:collapse;font-size:13px}
.tbl thead tr{border-bottom:1px solid var(--b3)}
.tbl tbody tr{border-bottom:1px solid var(--b1)}
.tbl tbody tr:nth-child(even){background:rgba(255,255,255,.015)}
.th{padding:10px 14px;font-size:11px;color:var(--t4);text-transform:uppercase;letter-spacing:.08em;font-weight:600;white-space:nowrap;text-align:left}
.td{padding:12px 14px}.dot-td{width:30px}
.sechdr{padding:8px 18px;background:rgba(255,255,255,.02);border-bottom:1px solid var(--b1)}
.crow{padding:10px 18px;border-bottom:1px solid var(--b1);display:flex;justify-content:space-between;align-items:center;gap:12px}
.crow .bdg{font-size:10px;padding:1px 6px}
.clink{font-size:11px;color:var(--t4);text-decoration:none}.clink:hover{color:var(--bl);text-decoration:underline}.clink+.clink::before{content:" | ";color:var(--t5)}
.empty{padding:32px 18px;text-align:center;color:var(--t5);font-size:13px}
.rbtn{font-size:11px;padding:5px 12px;border-radius:4px;font-weight:600;cursor:pointer;background:rgba(245,158,11,.15);color:var(--am);border:1px solid rgba(245,158,11,.3);min-width:100px;text-align:center;display:inline-block}
.rbtn.n{background:rgba(96,165,250,.15);color:var(--bl);border-color:rgba(96,165,250,.3)}
.rhint{margin-top:6px;font-size:11px;color:var(--t3);background:rgba(255,255,255,.05);border:1px solid var(--b4);border-radius:4px;padding:6px 10px}
.help-row{padding:14px 18px;border-top:1px solid var(--b1);display:flex;gap:16px;align-items:flex-start}
.help-lbl{flex-shrink:0;min-width:280px}
.help-cmd{font-size:12px;background:rgba(96,165,250,.1);color:var(--bl);padding:4px 10px;border-radius:4px;font-family:'SF Mono','Fira Code',monospace;font-weight:600}
.help-intro{padding:16px 18px 8px}
.help-foot{padding:16px 18px;border-top:1px solid var(--b2)}
.footer{padding:16px 24px 32px;display:flex;justify-content:space-between}
.addr-link{color:var(--t3);text-decoration:none}
.addr-link:hover{color:var(--bl);text-decoration:underline}
/* Loading skeleton */
.skel{background:linear-gradient(90deg,var(--b1) 25%,var(--b3) 50%,var(--b1) 75%);background-size:800px 100%;animation:shimmer 1.5s ease-in-out infinite;border-radius:4px}
.skel-stat{height:100px}
.skel-text{height:16px;border-radius:4px}
.skel-row{height:48px;border-bottom:1px solid var(--b1)}
/* Responsive */
@media(max-width:768px){
  .g4{grid-template-columns:repeat(2,1fr)}
  .g3,.g-ov{grid-template-columns:1fr}
  .main{padding:12px}
  .hdr-inner{padding:12px}
  .crow{flex-direction:column;align-items:flex-start;gap:6px}
  .tbl-wrap{-webkit-overflow-scrolling:touch}
  .nav .wrap{overflow-x:auto}
  .tab{padding:12px 14px;font-size:11px}
  .help-row{flex-direction:column;gap:6px}
  .help-lbl{min-width:0}
  .footer{flex-direction:column;gap:4px}
}
  </style>
</head>
<body>
  <div x-cloak x-data="dashboard()" x-init="init()" class="root">

    <!-- HEADER -->
    <header class="hdr">
      <div class="wrap hdr-inner">
        <div class="fx gap10" style="align-items:center">
          <img src="https://res.cloudinary.com/san-juan-fire-district-3/image/fetch/f_auto/https://www.sjifire.org/assets/sjifire-logo-clear.png" alt="SJIF&amp;R" style="height:52px;width:52px;border-radius:4px">
          <div>
            <div class="bb f20 t1 logo">SJIF&amp;R Operations Dashboard</div>
            <div class="up f11 t3 mt2">San Juan Island Fire &amp; Rescue</div>
          </div>
        </div>
        <div class="tar" x-show="!loading">
          <div class="f13 t3" x-text="D.date_display"></div>
          <div class="status f12 b" :class="D.open_calls ? 'active' : 'ok'">
            <span class="pulse"></span>
            <span x-text="D.open_calls ? D.open_calls + ' Active Call' + (D.open_calls > 1 ? 's' : '') : 'No Active Calls'"></span>
          </div>
          <div class="updated-row">
            <span class="f11 t4" x-text="'Updated ' + D.updated_time"></span>
            <span class="refresh-hint f11 b blu-t">Auto-updates every hour</span>
          </div>
        </div>
      </div>
    </header>

    <!-- NAV -->
    <nav class="nav">
      <div class="wrap fx">
        <template x-for="t in tabs" :key="t.id">
          <button class="tab" :class="{'on': activeTab === t.id}" @click="activeTab = t.id" x-text="t.label"></button>
        </template>
      </div>
    </nav>

    <main class="wrap main">

      <!-- LOADING SKELETON -->
      <div x-show="loading">
        <div class="g4 mb24">
          <div class="skel skel-stat"></div>
          <div class="skel skel-stat"></div>
          <div class="skel skel-stat"></div>
          <div class="skel skel-stat"></div>
        </div>
        <div class="g-ov">
          <div class="pnl">
            <div class="phdr"><div class="skel skel-text" style="width:140px"></div></div>
            <div class="skel skel-row"></div>
            <div class="skel skel-row"></div>
            <div class="skel skel-row"></div>
            <div class="skel skel-row"></div>
          </div>
          <div class="pnl">
            <div class="phdr"><div class="skel skel-text" style="width:120px"></div></div>
            <div class="skel skel-row"></div>
            <div class="skel skel-row"></div>
            <div class="skel skel-row"></div>
          </div>
        </div>
      </div>

      <!-- ERROR STATE -->
      <div x-show="error && !loading" class="empty" style="padding:40px">
        Failed to load dashboard data. Will retry automatically.
      </div>

      <!-- OVERVIEW TAB -->
      <div x-show="!loading && !error && activeTab === 'overview'">
        <div class="g4 mb24">
          <div class="stat" data-a="grn">
            <div class="up t4 f11 mb8">Open Calls</div>
            <div class="bb f28 t1 lh1" x-text="D.open_calls"></div>
            <div class="f12 t3 mt6" x-text="D.open_calls ? 'Active dispatch' : 'All clear'"></div>
          </div>
          <div class="stat" data-a="blu">
            <div class="up t4 f11 mb8">On Duty</div>
            <div class="bb f28 t1 lh1" x-text="D.unique_crew_count"></div>
            <div class="f12 t3 mt6" x-text="D.platoon"></div>
          </div>
          <div class="stat" data-a="amb">
            <div class="up t4 f11 mb8">Recent Calls</div>
            <div class="bb f28 t1 lh1" x-text="D.recent_calls.length"></div>
            <div class="f12 t3 mt6" x-text="D.neris_count + ' submitted to NERIS'"></div>
          </div>
          <div class="stat" data-a="pur">
            <div class="up t4 f11 mb8">Duty Officer</div>
            <div class="bb f28 t1 lh1" x-text="D.chief_officer || '\u2014'"></div>
            <div class="f12 t3 mt6">Chief Officer</div>
          </div>
        </div>
        <div class="g-ov">
          <!-- Crew panel -->
          <div class="pnl">
            <div class="phdr">
              <span class="f14 b t1" x-text="'On Duty \u2014 ' + D.platoon + (D.shift_until ? ' \u2014 until ' + D.shift_until : '')"></span>
              <span class="f11 t4" x-text="D.crew_date_range"></span>
            </div>
            <template x-if="D.crew.length">
              <div>
                <template x-for="c in D.crew" :key="c.name + c.shift">
                  <div class="orow">
                    <div>
                      <div class="f13 b t2" x-text="c.name"></div>
                      <div class="f11 t4 mt2" x-text="c.position"></div>
                    </div>
                    <span class="bdg" x-text="c.section"></span>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!D.crew.length">
              <div class="empty">No crew data available.</div>
            </template>
          </div>
          <!-- Recent calls panel -->
          <div class="pnl">
            <div class="phdr">
              <span class="f14 b t1">Recent Calls</span>
              <span class="f11 t4" x-text="D.recent_calls.slice(0, 5).length + ' calls'"></span>
            </div>
            <template x-if="D.recent_calls.length">
              <div>
                <template x-for="c in D.recent_calls.slice(0, 5)" :key="c.id">
                  <div class="call" :data-s="c.severity">
                    <div class="fx-s">
                      <div class="fx gap10">
                        <span class="f20 lh1" x-text="c.icon"></span>
                        <div>
                          <div class="f13 b t2" x-text="c.nature"></div>
                          <a :href="mapsUrl(c.address)" target="_blank" rel="noopener" class="f12 addr-link mt2" style="display:block" x-text="c.address"></a>
                        </div>
                      </div>
                      <div class="call-r">
                        <div class="f12 t3 b" x-text="c.date"></div>
                        <div class="f11 t4" x-text="c.time"></div>
                        <div class="f10 t5 mt4 mono" x-text="c.id"></div>
                        <div class="mt4">
                          <span x-show="c.has_report" class="f11 grn-t">&#10003; NERIS</span>
                          <span x-show="!c.has_report" class="f11 amb-t">&#9888; No report</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </template>
            <template x-if="!D.recent_calls.length">
              <div class="empty">No recent calls.</div>
            </template>
          </div>
        </div>
      </div>

      <!-- CALLS TAB -->
      <div x-show="!loading && !error && activeTab === 'calls'">
        <div class="pnl">
          <div class="phdr">
            <span class="f14 b t1">Dispatch Log</span>
            <span class="f11 t4" x-text="D.recent_calls.length + ' calls'"></span>
          </div>
          <div class="tbl-wrap">
            <table class="tbl">
              <thead>
                <tr>
                  <th class="th"></th>
                  <th class="th">ID</th>
                  <th class="th">Date/Time</th>
                  <th class="th">Nature</th>
                  <th class="th">Address</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="c in D.recent_calls" :key="c.id">
                  <tr>
                    <td class="td dot-td"><span class="dot" :data-s="c.severity"></span></td>
                    <td class="td mono t3 f12" x-text="c.id"></td>
                    <td class="td t2 nw" x-text="c.date + ' ' + c.time"></td>
                    <td class="td t1 b nw"><span x-text="c.icon + ' ' + c.nature"></span></td>
                    <td class="td"><a :href="mapsUrl(c.address)" target="_blank" rel="noopener" class="addr-link" x-text="c.address"></a></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CREW TAB -->
      <div x-show="!loading && !error && activeTab === 'crew'">
        <!-- Current crew -->
        <div class="pnl mb24">
          <div class="phdr">
            <span class="f14 b t1" x-text="D.platoon + ' \u2014 ' + D.crew_date_range"></span>
            <span class="bdg" x-text="D.shift_until ? 'until ' + D.shift_until : 'On duty'"></span>
          </div>
          <template x-if="D.sections.length">
            <div>
              <template x-for="s in D.sections" :key="s.key">
                <div>
                  <div class="sechdr f11 t4 b up" x-text="s.label"></div>
                  <template x-for="c in s.members" :key="c.name + c.shift">
                    <div class="crow">
                      <div class="fx" style="align-items:center;gap:8px;flex-wrap:wrap">
                        <span class="f13 b t2" x-text="c.name"></span>
                        <span class="bdg" :data-p="c.position" x-text="c.position"></span>
                        <span x-show="c.email || c.mobile">
                          <template x-if="c.email">
                            <a class="clink" :href="'mailto:' + c.email">email</a>
                          </template>
                          <template x-if="c.mobile">
                            <a class="clink" :href="'tel:' + c.mobile">mobile</a>
                          </template>
                        </span>
                      </div>
                      <span class="f12 t4 mono" x-text="c.shift"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
          <template x-if="!D.sections.length">
            <div class="empty">No crew data available.</div>
          </template>
        </div>
        <!-- Upcoming crew -->
        <div class="pnl" x-show="D.upcoming_sections.length">
          <div class="phdr">
            <span class="f14 b t1" x-text="'Upcoming \u2014 ' + D.upcoming_platoon + ' ' + D.upcoming_date_range"></span>
            <span class="bdg" x-text="D.upcoming_shift_starts ? 'starting at ' + D.upcoming_shift_starts : D.upcoming_crew.length + ' crew'"></span>
          </div>
          <template x-if="D.upcoming_sections.length">
            <div>
              <template x-for="s in D.upcoming_sections" :key="s.key">
                <div>
                  <div class="sechdr f11 t4 b up" x-text="s.label"></div>
                  <template x-for="c in s.members" :key="c.name + c.shift">
                    <div class="crow">
                      <div class="fx" style="align-items:center;gap:8px;flex-wrap:wrap">
                        <span class="f13 b t2" x-text="c.name"></span>
                        <span class="bdg" :data-p="c.position" x-text="c.position"></span>
                        <span x-show="c.email || c.mobile">
                          <template x-if="c.email">
                            <a class="clink" :href="'mailto:' + c.email">email</a>
                          </template>
                          <template x-if="c.mobile">
                            <a class="clink" :href="'tel:' + c.mobile">mobile</a>
                          </template>
                        </span>
                      </div>
                      <span class="f12 t4 mono" x-text="c.shift"></span>
                    </div>
                  </template>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>

      <!-- REPORTING TAB -->
      <div x-show="!loading && !error && activeTab === 'reporting'">
        <div class="g3 mb24">
          <div class="stat" data-a="blu">
            <div class="up t4 f11 mb8">In Progress</div>
            <div class="bb f28 t1 lh1" x-text="D.local_reports"></div>
            <div class="f12 t3 mt6">Drafts &amp; reviews</div>
          </div>
          <div class="stat" data-a="amb">
            <div class="up t4 f11 mb8">Missing Reports</div>
            <div class="bb f28 t1 lh1" x-text="D.missing_reports"></div>
            <div class="f12 t3 mt6">No incident report yet</div>
          </div>
          <div class="stat" data-a="grn">
            <div class="up t4 f11 mb8">In NERIS</div>
            <div class="bb f28 t1 lh1" x-text="D.neris_count"></div>
            <div class="f12 t3 mt6">Submitted to NERIS</div>
          </div>
        </div>
        <div class="pnl">
          <div class="phdr">
            <span class="f14 b t1">Incident Reports</span>
            <span class="bdg" x-text="D.recent_calls.length + ' incidents'"></span>
          </div>
          <div class="tbl-wrap">
            <table class="tbl">
              <thead>
                <tr>
                  <th class="th"></th>
                  <th class="th">ID</th>
                  <th class="th">Date</th>
                  <th class="th">Nature</th>
                  <th class="th">Status</th>
                  <th class="th">Action</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="c in D.recent_calls" :key="'rp-' + c.id">
                  <tr>
                    <td class="td dot-td"><span class="dot" :data-s="c.severity"></span></td>
                    <td class="td mono t3 f12" x-text="c.id"></td>
                    <td class="td t2 nw" x-text="c.date + ' ' + c.time"></td>
                    <td class="td t1 b nw"><span x-text="c.icon + ' ' + c.nature"></span></td>
                    <td class="td">
                      <template x-if="c.has_report">
                        <div>
                          <span class="f11 grn-t b">&#10003; <span x-text="c.report_status"></span></span>
                          <template x-if="c.neris_id">
                            <div class="f10 t4 mono mt2" x-text="c.neris_id"></div>
                          </template>
                        </div>
                      </template>
                      <template x-if="!c.has_report">
                        <span class="f11 amb-t">&#9888; Missing</span>
                      </template>
                    </td>
                    <td class="td">
                      <div>
                        <button class="rbtn" :class="{'n': c.has_report}" type="button" @click="showHint[c.id] = !showHint[c.id]" x-text="c.report_label"></button>
                        <div class="rhint" x-show="showHint[c.id]">
                          Ask Claude: <strong :class="c.has_report ? 'blu-t' : 'amb-t'" x-text="c.report_prompt"></strong>
                        </div>
                      </div>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- HELP TAB -->
      <div x-show="!loading && !error && activeTab === 'help'">
        <div class="pnl">
          <div class="phdr">
            <span class="f14 b t1">Claude Commands</span>
            <span class="f11 t4">Type these in the chat</span>
          </div>
          <div class="help-intro">
            <p class="f13 t3 mb16 lh15">Use these commands to interact with dispatch, crew, and reporting.</p>
          </div>
          <template x-for="h in helpCommands" :key="h[0]">
            <div class="help-row">
              <div class="help-lbl"><code class="help-cmd" x-text="h[0]"></code></div>
              <div class="f12 t3 lh15" x-text="h[1]"></div>
            </div>
          </template>
          <div class="help-foot">
            <p class="f12 t5 lh15">You can also ask Claude anything in natural language.</p>
          </div>
        </div>
      </div>

    </main>

    <footer class="wrap footer f11 t5">
      <span>San Juan County Fire District 3 &middot; 1011 Mullis Street, Friday Harbor, WA 98250</span>
      <span>&copy; 2026 SJIF&amp;R</span>
    </footer>

  </div>

  <script>
function dashboard() {
  return {
    D: {
      date_display: '', updated_time: '', is_business_hours: false,
      user_name: '', platoon: '', crew: [], unique_crew_count: 0,
      chief_officer: '', open_calls: 0, recent_calls: [],
      neris_count: 0, local_reports: 0, missing_reports: 0,
      sections: [], crew_date_range: '', shift_until: '',
      upcoming_platoon: '', upcoming_crew: [], upcoming_sections: [],
      upcoming_date_range: '', upcoming_shift_starts: ''
    },
    loading: true,
    error: false,
    activeTab: 'overview',
    showHint: {},
    tabs: [
      {id: 'overview', label: 'Overview'},
      {id: 'calls', label: 'Recent Calls'},
      {id: 'crew', label: 'On Duty'},
      {id: 'reporting', label: 'Reporting'},
      {id: 'help', label: 'Help'}
    ],
    helpCommands: [
      ['refresh', 'Refresh dashboard'],
      ['Start a report for 26-XXXXXX', 'Create incident report'],
      ['Import NERIS data for 26-XXXXXX', 'Pull existing NERIS submission into a draft'],
      ['Show me call 26-XXXXXX', 'Get dispatch call details'],
      ['Who was on duty Jan 15?', 'Look up crew for any date'],
      ['List incidents', 'Show draft/in-progress reports'],
      ['Submit incident for [ID]', 'Submit to NERIS'],
      ['Search calls from Jan 1 to Jan 31', 'Search dispatch archive'],
      ['Show open calls', 'Check active calls']
    ],

    async init() {
      await this.refresh();
      setInterval(() => this.refresh(), 3600000);
    },

    async refresh() {
      try {
        const r = await fetch('/dashboard/data');
        if (r.ok) {
          this.D = await r.json();
          this.loading = false;
          this.error = false;
        } else if (r.status === 401) {
          location.reload();
        } else {
          this.error = true;
          this.loading = false;
        }
      } catch (e) {
        console.error('Dashboard refresh failed:', e);
        this.error = true;
        this.loading = false;
      }
    },

    mapsUrl(addr) {
      return 'https://www.google.com/maps/search/?api=1&query=' +
        encodeURIComponent((addr || '') + ', San Juan Island, WA');
    }
  };
}
  </script>
</body>
</html>
