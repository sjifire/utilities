{% extends "base.html" %}

{% block title %}Incident Reports{% endblock %}

{% block head_scripts %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.14/dist/cdn.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>
{% endblock %}

{% block extra_styles %}
<style>
    /* Reports main */
    .reports-main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }
    .reports-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    /* Table hover */
    .data-table tbody tr { transition: background .15s; }
    .data-table tbody tr:hover { background: rgba(96, 165, 250, .06); }

    /* ── Report details ── */
    .neris-id {
      font-size: 10px;
      color: var(--text-dim);
      font-family: monospace;
      margin-top: 2px;
    }
    .completeness {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
    }
    .completeness-bar {
      display: inline-block;
      width: 40px;
      height: 3px;
      background: var(--border-default);
      border-radius: 2px;
      vertical-align: middle;
      margin-left: 4px;
    }
    .completeness-fill {
      height: 100%;
      border-radius: 2px;
      background: var(--color-blue);
    }

    /* ── Cell styles ── */
    .call-id { font-family: monospace; font-size: 12px; color: var(--text-muted); }
    .nature  { color: var(--text-primary); font-weight: 600; white-space: nowrap; }
    .address { color: var(--text-secondary); font-size: 12px; margin-top: 2px; }
    .dt      { white-space: nowrap; color: var(--text-secondary); }
    .dt-time { color: var(--text-muted); font-size: 12px; }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal {
      background: var(--bg-panel);
      border: 1px solid var(--border-medium);
      border-radius: 10px;
      padding: 24px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
    }
    .modal h2 {
      font-size: 16px;
      color: var(--text-primary);
      margin-bottom: 16px;
    }
    .modal label {
      display: block;
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .05em;
    }
    .modal input,
    .modal select {
      width: 100%;
      background: var(--bg-page);
      border: 1px solid var(--border-medium);
      border-radius: 6px;
      color: var(--text-secondary);
      padding: 8px 12px;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 12px;
    }
    .modal input:focus,
    .modal select:focus {
      outline: none;
      border-color: var(--color-blue);
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 8px;
    }
    .modal-actions button {
      padding: 8px 18px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .btn-primary { background: var(--color-blue); color: #fff; }
    .btn-primary:hover { background: #4a94f0; }
    .btn-secondary { background: var(--border-medium); color: var(--text-muted); }
    .btn-secondary:hover { background: var(--border-strong); }

    /* ── Help section ── */
    .help-row {
      padding: 14px 18px;
      border-top: 1px solid var(--border-subtle);
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    .help-label { flex-shrink: 0; min-width: 280px; }
    .help-cmd {
      font-size: 12px;
      background: rgba(96, 165, 250, .1);
      color: var(--color-blue);
      padding: 4px 10px;
      border-radius: 4px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      font-weight: 600;
    }
    .help-intro  { padding: 16px 18px 8px; }
    .help-footer { padding: 16px 18px; border-top: 1px solid var(--border-default); }

    /* ── Chat drawer ── */
    .chat-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 50;
      background: var(--color-blue);
      color: #fff;
      border: none;
      border-radius: 28px;
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(0, 0, 0, .4);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background .15s, transform .15s;
    }
    .chat-fab:hover { background: #4a94f0; transform: translateY(-1px); }
    .chat-fab-icon { font-size: 16px; }

    .chat-drawer {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 60;
      width: 400px;
      height: 520px;
      background: var(--bg-panel);
      border: 1px solid var(--border-medium);
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .chat-drawer-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-default);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      background: var(--bg-panel-alt);
    }
    .chat-drawer-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .chat-drawer-close {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      line-height: 1;
    }
    .chat-drawer-close:hover { color: var(--text-muted); }

    .chat-drawer-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .chat-drawer-messages::-webkit-scrollbar       { width: 5px; }
    .chat-drawer-messages::-webkit-scrollbar-thumb { background: var(--border-medium); border-radius: 3px; }

    .chat-msg {
      max-width: 90%;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.5;
    }
    .chat-msg.user {
      align-self: flex-end;
      background: var(--color-blue);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .chat-msg.assistant {
      align-self: flex-start;
      background: var(--bg-page);
      border: 1px solid var(--border-default);
      border-bottom-left-radius: 4px;
    }
    .chat-msg.assistant p             { margin-bottom: 6px; }
    .chat-msg.assistant p:last-child  { margin-bottom: 0; }
    .chat-msg.assistant strong        { color: var(--text-primary); }
    .chat-msg.assistant code          { background: var(--border-medium); padding: 1px 4px; border-radius: 3px; font-size: 12px; }
    .chat-msg.assistant ul,
    .chat-msg.assistant ol            { margin: 4px 0 6px 16px; }
    .chat-msg.assistant li            { margin-bottom: 2px; }

    .chat-tool-indicator {
      align-self: flex-start;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--border-subtle);
      border: 1px solid var(--border-default);
      border-radius: 6px;
      font-size: 11px;
      color: var(--text-dim);
    }
    .chat-tool-indicator .spinner {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border-medium);
      border-top-color: var(--color-blue);
      border-radius: 50%;
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .chat-tool-result {
      align-self: flex-start;
      padding: 6px 10px;
      background: var(--green-alpha);
      border: 1px solid rgba(34, 197, 94, .2);
      border-radius: 6px;
      font-size: 11px;
      color: var(--color-green);
    }

    .chat-typing {
      align-self: flex-start;
      display: flex;
      gap: 3px;
      padding: 10px 14px;
      background: var(--bg-page);
      border: 1px solid var(--border-default);
      border-radius: 10px;
      border-bottom-left-radius: 4px;
    }
    .chat-typing span              { width: 6px; height: 6px; background: var(--text-dim); border-radius: 50%; animation: bounce 1.4s infinite; }
    .chat-typing span:nth-child(2) { animation-delay: .2s; }
    .chat-typing span:nth-child(3) { animation-delay: .4s; }
    @keyframes bounce {
      0%, 60%, 100% { transform: translateY(0); }
      30%           { transform: translateY(-5px); }
    }

    .chat-error {
      background: var(--red-alpha);
      border: 1px solid rgba(220, 38, 38, .3);
      color: var(--color-error);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      text-align: center;
      align-self: stretch;
    }

    .chat-drawer-input {
      border-top: 1px solid var(--border-default);
      padding: 10px 12px;
      display: flex;
      gap: 8px;
      align-items: flex-end;
      flex-shrink: 0;
    }
    .chat-drawer-input textarea {
      flex: 1;
      background: var(--bg-page);
      border: 1px solid var(--border-medium);
      border-radius: 6px;
      color: var(--text-secondary);
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
      resize: none;
      min-height: 36px;
      max-height: 80px;
      line-height: 1.4;
    }
    .chat-drawer-input textarea:focus       { outline: none; border-color: var(--color-blue); }
    .chat-drawer-input textarea::placeholder { color: var(--text-dim); }
    .chat-drawer-input textarea:disabled    { opacity: .5; }

    /* ── Suggestion chips ── */
    .chat-hints {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }
    .chat-hint {
      background: var(--border-subtle);
      border: 1px solid var(--border-default);
      color: var(--text-muted);
      font-size: 11px;
      padding: 5px 11px;
      border-radius: 14px;
      cursor: pointer;
      transition: background .15s, border-color .15s;
      white-space: nowrap;
    }
    .chat-hint:hover {
      background: rgba(96, 165, 250, .1);
      border-color: var(--color-blue);
      color: var(--text-secondary);
    }
    .chat-send-btn {
      background: var(--color-blue);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      height: 36px;
    }
    .chat-send-btn:hover:not(:disabled) { background: #4a94f0; }
    .chat-send-btn:disabled { opacity: .4; cursor: not-allowed; }

    /* ── Reports responsive ── */
    @media (max-width: 768px) {
      .reports-main { padding: 16px; }
      .reports-stats { grid-template-columns: 1fr; }
      .data-table th:nth-child(n+5),
      .data-table td:nth-child(n+5) { display: none; }
      .help-row { flex-direction: column; gap: 6px; }
      .help-label { min-width: 0; }
      .chat-drawer { width: calc(100vw - 16px); right: 8px; bottom: 8px; height: 70vh; }
      .chat-fab { bottom: 16px; right: 16px; }
    }
</style>
{% endblock %}

{% block body_attrs %}x-data="reportsApp()" x-cloak{% endblock %}

{% block tab_bar %}
<div class="nav-bar">
  <div class="nav-bar-left">
    <button class="nav-tab" :class="{ active: filter === 'all' }" @click="filter = 'all'">
      All <span style="opacity:.6" x-text="'(' + calls.length + ')'"></span>
    </button>
    <button class="nav-tab" :class="{ active: filter === 'missing' }" @click="filter = 'missing'">
      Missing Report <span style="opacity:.6" x-text="'(' + countByFilter('missing') + ')'"></span>
    </button>
    <button class="nav-tab" :class="{ active: filter === 'local' }" @click="filter = 'local'">
      In Progress <span style="opacity:.6" x-text="'(' + countByFilter('local') + ')'"></span>
    </button>
    <button class="nav-tab" :class="{ active: filter === 'neris' }" @click="filter = 'neris'">
      Submitted <span style="opacity:.6" x-text="'(' + countByFilter('neris') + ')'"></span>
    </button>
    <button class="nav-tab" :class="{ active: filter === 'help' }" @click="filter = 'help'">
      Help
    </button>
  </div>
</div>
{% endblock %}

{% block body %}
<div class="reports-main">
  <!-- Stats (hidden on help tab) -->
  <div class="reports-stats" x-show="filter !== 'help'">
    <div class="stat-card accent-blue">
      <div class="stat-label">In Progress</div>
      <div class="stat-value">{{ local_draft_count }}</div>
      <div class="stat-desc">Drafts &amp; reviews</div>
    </div>
    <div class="stat-card accent-amber">
      <div class="stat-label">Missing Reports</div>
      <div class="stat-value">{{ missing_reports }}</div>
      <div class="stat-desc">No incident report yet</div>
    </div>
    <div class="stat-card accent-green">
      <div class="stat-label">In NERIS</div>
      <div class="stat-value">{{ neris_count }}</div>
      <div class="stat-desc">Submitted to NERIS</div>
    </div>
  </div>

  <!-- Help panel -->
  <div x-show="filter === 'help'">
    <div class="panel">
      <div class="panel-header">
        <span style="font-size:14px;color:var(--text-primary)" class="font-semibold">Assistant Commands</span>
        <span style="font-size:11px;color:var(--text-dim)">Ask the assistant using the chat button below</span>
      </div>
      <div class="help-intro">
        <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px;line-height:1.5">Use these commands to interact with dispatch, crew, and reporting.</p>
      </div>
      <template x-for="h in helpCommands" :key="h[0]">
        <div class="help-row">
          <div class="help-label"><code class="help-cmd" x-text="h[0]"></code></div>
          <div style="font-size:12px;color:var(--text-muted);line-height:1.5" x-text="h[1]"></div>
        </div>
      </template>
      <div class="help-footer">
        <p style="font-size:12px;color:var(--text-faint);line-height:1.5">You can also ask anything in natural language using the chat assistant.</p>
      </div>
    </div>
  </div>

  <!-- Table -->
  <template x-if="filter !== 'help' && filtered().length > 0">
    <div class="panel data-table-wrap">
      <table class="data-table">
        <thead>
          <tr>
            <th class="dot-cell"></th>
            <th>ID</th>
            <th>Date/Time</th>
            <th>Nature</th>
            <th>Address</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="c in filtered()" :key="c.id">
            <tr>
              <td class="dot-cell"><span class="severity-dot" :class="c.severity"></span></td>
              <td class="call-id" x-text="c.id"></td>
              <td class="dt">
                <div x-text="c.date"></div>
                <div class="dt-time" x-text="c.time"></div>
              </td>
              <td>
                <div class="nature" x-text="c.icon + ' ' + c.nature"></div>
              </td>
              <td class="address" x-text="c.address || '\u2014'"></td>
              <td>
                <!-- NERIS only (no local draft) -->
                <template x-if="c.report_source === 'neris'">
                  <div>
                    <div class="report-status neris" x-text="'\u2713 In NERIS'"></div>
                    <div class="neris-id" x-text="c.neris_id || 'No local report'"></div>
                  </div>
                </template>
                <!-- Local draft -->
                <template x-if="c.report_source === 'local'">
                  <div>
                    <div class="report-status local" x-text="c.report_status || 'draft'"></div>
                    <template x-if="c.completeness">
                      <div class="completeness">
                        <span x-text="c.completeness.filled + '/' + c.completeness.total"></span>
                        <span class="completeness-bar"><span class="completeness-fill" :style="'width:' + (c.completeness.total ? (c.completeness.filled / c.completeness.total * 100) : 0) + '%'"></span></span>
                      </div>
                    </template>
                  </div>
                </template>
                <!-- No report -->
                <template x-if="!c.has_report">
                  <div class="report-status missing">&triangledown; Missing</div>
                </template>
              </td>
              <td>
                <!-- Local draft: Edit -->
                <template x-if="c.report_source === 'local' && c.incident_id">
                  <a class="action-btn edit" :href="'/reports/' + c.incident_id" @click.stop>Edit Report</a>
                </template>
                <!-- NERIS only: Import -->
                <template x-if="c.report_source === 'neris'">
                  <button class="action-btn import" @click.stop="startReport(c)">Import from NERIS</button>
                </template>
                <!-- No report: Start -->
                <template x-if="!c.has_report">
                  <button class="action-btn start" @click.stop="startReport(c)">Start Report</button>
                </template>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </template>

  <!-- Empty state -->
  <template x-if="filter !== 'help' && filtered().length === 0">
    <div class="empty-state" style="padding:60px 20px">
      <h2>No calls match this filter</h2>
      <p>Try a different filter or check back later.</p>
    </div>
  </template>
</div>

<!-- New Report Modal -->
<template x-if="showModal">
  <div class="modal-overlay" @click.self="showModal = false" @keydown.escape.window="showModal = false">
    <div class="modal">
      <h2>Start Incident Report</h2>
      <form method="POST" action="/reports/new" @submit="submitting = true">
        <label for="incident_number">Incident Number</label>
        <input type="text" id="incident_number" name="incident_number" :value="modalCallId" required readonly style="opacity:.7">

        <label for="incident_date">Incident Date</label>
        <input type="date" id="incident_date" name="incident_date" :value="modalDate" required>

        <label for="station">Station</label>
        <select id="station" name="station">
          <option value="S31" selected>S31 &mdash; Friday Harbor</option>
        </select>

        <div class="modal-actions">
          <button type="button" class="btn-secondary" @click="showModal = false">Cancel</button>
          <button type="submit" class="btn-primary" :disabled="submitting" x-text="submitting ? 'Creating...' : 'Create Report'"></button>
        </div>
      </form>
    </div>
  </div>
</template>

<!-- Chat FAB (shown when drawer is closed) -->
<button class="chat-fab" x-show="!chatOpen" @click="openChat()">
  <span class="chat-fab-icon">&#128172;</span> Ask Assistant
</button>

<!-- Chat Drawer -->
<div class="chat-drawer" x-show="chatOpen" x-transition.opacity>
  <div class="chat-drawer-header">
    <span class="chat-drawer-title">Operations Assistant</span>
    <button class="chat-drawer-close" @click="chatOpen = false">&times;</button>
  </div>
  <div class="chat-drawer-messages" x-ref="chatMessages">
    <!-- Suggestion chips (shown when conversation is empty) -->
    <template x-if="chatMessages.length === 0 && !chatStreaming">
      <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;padding:16px">
        <p style="font-size:12px;color:var(--text-dim)">Try asking</p>
        <div class="chat-hints">
          <button class="chat-hint" @click="chatInput='Who is on duty today?';sendChatMessage()">Who's on duty?</button>
          <button class="chat-hint" @click="chatInput='Show recent calls';sendChatMessage()">Recent calls</button>
          <button class="chat-hint" @click="chatInput='Which reports are missing?';sendChatMessage()">Missing reports</button>
          <button class="chat-hint" @click="chatInput='Look up a NERIS code for structure fire';sendChatMessage()">NERIS codes</button>
        </div>
      </div>
    </template>
    <template x-for="(msg, i) in chatMessages" :key="i">
      <div>
        <template x-if="msg.type === 'message'">
          <div class="chat-msg" :class="msg.role" x-html="msg.role === 'assistant' ? renderMarkdown(msg.content) : msg.content"></div>
        </template>
        <template x-if="msg.type === 'tool_call'">
          <div class="chat-tool-indicator">
            <template x-if="msg.pending"><div class="spinner"></div></template>
            <span x-text="msg.label"></span>
          </div>
        </template>
        <template x-if="msg.type === 'tool_result'">
          <div class="chat-tool-result" x-text="'\u2713 ' + msg.summary"></div>
        </template>
        <template x-if="msg.type === 'error'">
          <div class="chat-error" x-text="msg.content"></div>
        </template>
      </div>
    </template>
    <template x-if="chatStreaming && !chatCurrentText">
      <div class="chat-typing"><span></span><span></span><span></span></div>
    </template>
    <template x-if="chatStreaming && chatCurrentText">
      <div class="chat-msg assistant" x-html="renderMarkdown(chatCurrentText)"></div>
    </template>
  </div>
  <div class="chat-drawer-input">
    <textarea
      x-ref="chatInput"
      x-model="chatInput"
      :disabled="chatStreaming"
      placeholder="Ask about calls, crew, NERIS codes..."
      @keydown.enter.prevent="if (!$event.shiftKey) sendChatMessage()"
      @input="chatAutoResize($event)"
      rows="1"
    ></textarea>
    <button class="chat-send-btn" :disabled="chatStreaming || !chatInput.trim()" @click="sendChatMessage()">Send</button>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
<script>
function reportsApp() {
  return {
    calls: {{ calls | tojson }},
    filter: 'all',
    showModal: false,
    submitting: false,
    modalCallId: '',
    modalDate: '{{ today }}',

    // Help tab data
    helpCommands: [
      ['Who is on duty today?', 'Look up current crew schedule'],
      ['Who was on duty Jan 15?', 'Look up crew for any date'],
      ['Show me call 26-XXXXXX', 'Get dispatch call details'],
      ['Show recent calls', 'List the last 30 days of calls'],
      ['Search calls from Jan 1 to Jan 31', 'Search dispatch archive'],
      ['List incidents', 'Show draft/in-progress reports'],
      ['Look up NERIS code for structure fire', 'Search NERIS value sets'],
      ['What is the incident type for a chimney fire?', 'Find specific NERIS codes']
    ],

    // Chat drawer state
    chatOpen: false,
    chatMessages: [],
    chatInput: '',
    chatStreaming: false,
    chatCurrentText: '',
    chatLoaded: false,

    filtered() {
      if (this.filter === 'all') return this.calls;
      if (this.filter === 'missing') return this.calls.filter(c => !c.has_report);
      if (this.filter === 'local') return this.calls.filter(c => c.report_source === 'local');
      if (this.filter === 'neris') return this.calls.filter(c => c.report_source === 'neris');
      return this.calls;
    },

    countByFilter(f) {
      if (f === 'missing') return this.calls.filter(c => !c.has_report).length;
      if (f === 'local') return this.calls.filter(c => c.report_source === 'local').length;
      if (f === 'neris') return this.calls.filter(c => c.report_source === 'neris').length;
      return this.calls.length;
    },

    startReport(call) {
      this.modalCallId = call.id;
      this.modalDate = this.parseCallDate(call.date) || '{{ today }}';
      this.showModal = true;
    },

    parseCallDate(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr + ' {{ today[:4] }}');
      if (isNaN(d)) return null;
      return d.toISOString().split('T')[0];
    },

    // ── Chat drawer methods ──

    renderMarkdown(text) {
      if (!text) return '';
      try {
        return DOMPurify.sanitize(marked.parse(text));
      } catch {
        return text;
      }
    },

    async openChat() {
      this.chatOpen = true;
      if (!this.chatLoaded) {
        await this.loadChatHistory();
        this.chatLoaded = true;
      }
      this.$nextTick(() => {
        if (this.$refs.chatInput) this.$refs.chatInput.focus();
      });
    },

    async loadChatHistory() {
      try {
        const res = await fetch('/chat/history');
        if (res.ok) {
          const data = await res.json();
          for (const msg of data.messages || []) {
            if (msg.content) {
              this.chatMessages.push({type: 'message', role: msg.role, content: msg.content});
            }
            if (msg.tool_use) {
              for (const tu of msg.tool_use) {
                this.chatMessages.push({
                  type: 'tool_result',
                  summary: tu.name + ' completed',
                });
              }
            }
          }
          this.chatScrollToBottom();
        }
      } catch (e) {
        console.error('Failed to load chat history:', e);
      }
    },

    chatAutoResize(e) {
      const ta = e.target;
      ta.style.height = 'auto';
      ta.style.height = Math.min(ta.scrollHeight, 80) + 'px';
    },

    chatScrollToBottom() {
      this.$nextTick(() => {
        const el = this.$refs.chatMessages;
        if (el) el.scrollTop = el.scrollHeight;
      });
    },

    async sendChatMessage() {
      const text = this.chatInput.trim();
      if (!text || this.chatStreaming) return;

      this.chatMessages.push({type: 'message', role: 'user', content: text});
      this.chatInput = '';
      this.chatStreaming = true;
      this.chatCurrentText = '';
      this.chatScrollToBottom();

      if (this.$refs.chatInput) this.$refs.chatInput.style.height = 'auto';

      try {
        const res = await fetch('/chat/stream', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({message: text})
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({error: 'Request failed'}));
          this.chatMessages.push({type: 'error', content: err.error || 'Request failed'});
          this.chatStreaming = false;
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const {done, value} = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, {stream: true});
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          let eventType = '';
          for (const line of lines) {
            if (line.startsWith('event: ')) {
              eventType = line.slice(7).trim();
            } else if (line.startsWith('data: ') && eventType) {
              try {
                const data = JSON.parse(line.slice(6));
                this.handleChatEvent(eventType, data);
              } catch {}
              eventType = '';
            }
          }
        }
      } catch (e) {
        console.error('Chat error:', e);
        this.chatMessages.push({type: 'error', content: 'Connection error. Please try again.'});
      }

      if (this.chatCurrentText) {
        this.chatMessages.push({type: 'message', role: 'assistant', content: this.chatCurrentText});
        this.chatCurrentText = '';
      }
      this.chatStreaming = false;
      this.chatScrollToBottom();
    },

    handleChatEvent(type, data) {
      if (type === 'text') {
        this.chatCurrentText += data.content || '';
        this.chatScrollToBottom();
      } else if (type === 'tool_call') {
        if (this.chatCurrentText) {
          this.chatMessages.push({type: 'message', role: 'assistant', content: this.chatCurrentText});
          this.chatCurrentText = '';
        }
        const labels = {
          get_dispatch_call: 'Looking up dispatch data...',
          list_dispatch_calls: 'Listing recent calls...',
          search_dispatch_calls: 'Searching dispatch calls...',
          get_on_duty_crew: 'Checking crew schedule...',
          get_neris_values: 'Looking up NERIS values...',
          list_incidents: 'Listing incident reports...',
          get_incident: 'Loading incident data...'
        };
        this.chatMessages.push({
          type: 'tool_call',
          label: labels[data.name] || `Running ${data.name}...`,
          pending: true
        });
        this.chatScrollToBottom();
      } else if (type === 'tool_result') {
        for (let i = this.chatMessages.length - 1; i >= 0; i--) {
          if (this.chatMessages[i].type === 'tool_call' && this.chatMessages[i].pending) {
            this.chatMessages[i].pending = false;
            break;
          }
        }
        this.chatMessages.push({
          type: 'tool_result',
          summary: data.summary || data.name,
        });
        this.chatScrollToBottom();
      } else if (type === 'done') {
        // Turn complete
      } else if (type === 'error') {
        if (this.chatCurrentText) {
          this.chatMessages.push({type: 'message', role: 'assistant', content: this.chatCurrentText});
          this.chatCurrentText = '';
        }
        this.chatMessages.push({type: 'error', content: data.message});
        this.chatScrollToBottom();
      }
    }
  };
}
</script>
{% endblock %}
