name: Calendar Sync

on:
  schedule:
    # Current month: 3x daily at 9am, 4pm, 7pm Pacific
    - cron: '0 17 * * *'  # 9am PST / 10am PDT
    - cron: '0 0 * * *'   # 4pm PST / 5pm PDT
    - cron: '0 3 * * *'   # 7pm PST / 8pm PDT
    # Future months: 1x daily at noon Pacific
    - cron: '0 20 * * *'  # 12pm PST / 1pm PDT
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no changes)'
        required: false
        default: false
        type: boolean
      months:
        description: 'Number of months to sync (default: 4)'
        required: false
        default: '4'
        type: string

permissions:
  id-token: write
  contents: read
  actions: none
  checks: none
  deployments: none
  issues: none
  packages: none
  pull-requests: none
  repository-projects: none
  security-events: none
  statuses: none

jobs:
  sync:
    name: Sync Aladtec Schedules to M365 Calendars
    runs-on: ubuntu-latest
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Azure login with OIDC
        uses: azure/login@v2
        with:
          client-id: bb2cb591-58ff-4687-bf14-502049dee01b
          tenant-id: 4122848f-c317-4267-9c07-7c504150d1bd
          allow-no-subscriptions: true

      - name: Get secrets from Key Vault
        uses: azure/cli@v2
        with:
          azcliversion: agentazcliversion
          inlineScript: |
            ALADTEC_URL=$(az keyvault secret show --vault-name gh-website-utilities --name ALADTEC-URL --query value -o tsv)
            echo "::add-mask::$ALADTEC_URL"
            echo "ALADTEC_URL=$ALADTEC_URL" >> $GITHUB_ENV

            ALADTEC_USERNAME=$(az keyvault secret show --vault-name gh-website-utilities --name ALADTEC-USERNAME --query value -o tsv)
            echo "::add-mask::$ALADTEC_USERNAME"
            echo "ALADTEC_USERNAME=$ALADTEC_USERNAME" >> $GITHUB_ENV

            ALADTEC_PASSWORD=$(az keyvault secret show --vault-name gh-website-utilities --name ALADTEC-PASSWORD --query value -o tsv)
            echo "::add-mask::$ALADTEC_PASSWORD"
            echo "ALADTEC_PASSWORD=$ALADTEC_PASSWORD" >> $GITHUB_ENV

            MS_GRAPH_TENANT_ID=$(az keyvault secret show --vault-name gh-website-utilities --name MS-GRAPH-TENANT-ID --query value -o tsv)
            echo "::add-mask::$MS_GRAPH_TENANT_ID"
            echo "MS_GRAPH_TENANT_ID=$MS_GRAPH_TENANT_ID" >> $GITHUB_ENV

            MS_GRAPH_CLIENT_ID=$(az keyvault secret show --vault-name gh-website-utilities --name MS-GRAPH-CLIENT-ID --query value -o tsv)
            echo "::add-mask::$MS_GRAPH_CLIENT_ID"
            echo "MS_GRAPH_CLIENT_ID=$MS_GRAPH_CLIENT_ID" >> $GITHUB_ENV

            MS_GRAPH_CLIENT_SECRET=$(az keyvault secret show --vault-name gh-website-utilities --name MS-GRAPH-CLIENT-SECRET --query value -o tsv)
            echo "::add-mask::$MS_GRAPH_CLIENT_SECRET"
            echo "MS_GRAPH_CLIENT_SECRET=$MS_GRAPH_CLIENT_SECRET" >> $GITHUB_ENV

            SVC_AUTOMATIONS_USERNAME=$(az keyvault secret show --vault-name gh-website-utilities --name SVC-AUTOMATIONS-USERNAME --query value -o tsv)
            echo "::add-mask::$SVC_AUTOMATIONS_USERNAME"
            echo "SVC_AUTOMATIONS_USERNAME=$SVC_AUTOMATIONS_USERNAME" >> $GITHUB_ENV

            SVC_AUTOMATIONS_PASSWORD=$(az keyvault secret show --vault-name gh-website-utilities --name SVC-AUTOMATIONS-PASSWORD --query value -o tsv)
            echo "::add-mask::$SVC_AUTOMATIONS_PASSWORD"
            echo "SVC_AUTOMATIONS_PASSWORD=$SVC_AUTOMATIONS_PASSWORD" >> $GITHUB_ENV

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.14

      - name: Install dependencies
        run: uv sync

      - name: Run duty calendar sync
        run: |
          MAILBOX="all-personnel@sjifire.org"
          SCHEDULE_CACHE="/tmp/schedule.json"
          # Noon schedule (0 20 * * *) syncs 4 months; others sync current month only
          if [ "${{ github.event.schedule }}" = "0 20 * * *" ]; then
            MONTHS="4"
          else
            MONTHS="${{ inputs.months || '1' }}"
          fi
          echo "Syncing $MONTHS month(s) to $MAILBOX"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            uv run duty-calendar-sync --months "$MONTHS" --mailbox "$MAILBOX" --save-schedule "$SCHEDULE_CACHE" --dry-run
          else
            uv run duty-calendar-sync --months "$MONTHS" --mailbox "$MAILBOX" --save-schedule "$SCHEDULE_CACHE"
          fi

      - name: Run personal calendar sync
        run: |
          SCHEDULE_CACHE="/tmp/schedule.json"
          # Use same months as duty sync
          if [ "${{ github.event.schedule }}" = "0 20 * * *" ]; then
            MONTHS="4"
          else
            MONTHS="${{ inputs.months || '1' }}"
          fi
          echo "Syncing personal calendars for $MONTHS month(s) from cache"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            uv run personal-calendar-sync --all --months "$MONTHS" --load-schedule "$SCHEDULE_CACHE" --dry-run
          else
            uv run personal-calendar-sync --all --months "$MONTHS" --load-schedule "$SCHEDULE_CACHE"
          fi
